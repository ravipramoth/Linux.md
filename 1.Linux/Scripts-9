#!/bin/bash

# Required binaries
COMMAND=/bin/command
CUT=/bin/cut
TR=/bin/tr
AWK=/bin/awk
ECHO=/bin/echo
CAT=/bin/cat
TEE=/bin/tee
LOG_FILE=/root/log/senddevops.log

# SNS topic
SNS_TOPIC_ARN="arn:aws:sns:us-east-1:308414302073:tesing"

# Start logging
${ECHO} $(date '+%F') "Validating docker tool" | ${TEE} -a ${LOG_FILE}
if ${COMMAND} -v docker 1>/dev/null 2>&1 ; then 
    DOCKER=$(${COMMAND} -v docker)
    dockerVer=$(${DOCKER} --version | ${CUT} -d ' ' -f3 | ${TR} -d ',') 
    ${ECHO} $(date '+%F') "DOCKER Version is : ${dockerVer} " | ${TEE} -a ${LOG_FILE}
else
    dockerVer="Not Found"
fi

${ECHO} $(date '+%F') "Validating ansible tool" | ${TEE} -a ${LOG_FILE}
if ${COMMAND} -v ansible 1>/dev/null 2>&1 ; then 
    ANSIBLE=$(${COMMAND} -v ansible)
    ansibleVer=$(${ANSIBLE} --version | ${AWK} 'NR==1' | ${CUT}  -d ' ' -f3 | tr -d ']')
    ${ECHO} $(date '+%F') "ANSIBLE Version is : ${ansibleVer} " | ${TEE} -a ${LOG_FILE}
else 
    ansibleVer="Not Found"
fi 

${ECHO} $(date '+%F') "Validating java tool" >> ${LOG_FILE}
if ${COMMAND} -v java 1>/dev/null 2>&1 ; then
    JAVA=$(${COMMAND} -v java)
    javaVer=$(${JAVA} -version 2>&1 | ${AWK} 'NR==1' | ${CUT}  -d ' ' -f3 | ${TR} -d '"')
    ${ECHO} $(date '+%F') "JAVA Version is : ${javaVer} " >> ${LOG_FILE}
else 
    javaVer="Not Found"
fi 

${ECHO} $(date '+%F') "Validating nginx tool" >> ${LOG_FILE}
if ${COMMAND} -v nginx 1>/dev/null 2>&1 ; then
    NGINX=$(${COMMAND} -v nginx)
    nginxVer=$(${NGINX} -version 2>&1 | ${CUT}  -d '/' -f2) 
    ${ECHO} $(date '+%F') "NGINX Version is : ${nginxVer} " >> ${LOG_FILE}
    
else 
    nginxVer="Not Found"
fi 

# Compose plain-text message for SNS
SNS_MESSAGE=$(cat <<EOF
DevOps Tools Report on $(hostname):

Tool       | Version
-----------|---------
Docker     | ${dockerVer}
Ansible    | ${ansibleVer}
Java       | ${javaVer}
Nginx      | ${nginxVer}

-- Report generated by automation script
EOF
)

# Publish to SNS
aws sns publish \
  --topic-arn "arn:aws:sns:us-east-1:308414302073:tesing" \
  --message "testing" \
  --subject "DevOps Tools Version Report from $(hostname)"


------------------------------------------------------- 
'

